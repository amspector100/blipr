<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="blipr">
<title>BLiP for controlled variable selection • blipr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="BLiP for controlled variable selection">
<meta property="og:description" content="blipr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">blipr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../index.html">Home</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../articles/index.html">Vignettes</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">API Reference</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/amspector100/blipr">blipr source</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/amspector100/pyblip">pyblip source</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://arxiv.org/abs/2203.17208">BLiP paper (arXiv)</a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">

<div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>BLiP for controlled variable selection</h1>
            
      
      
      <div class="d-none name"><code>blipr-regression.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="problem-setting">Problem setting<a class="anchor" aria-label="anchor" href="#problem-setting"></a>
</h2>
<p>Suppose we observe highly correlated covariates <span class="math inline">\(X = (X_1, \dots, X_p)\)</span> and a response <span class="math inline">\(Y\)</span>, and we seek to discover covariates <span class="math inline">\(X_j\)</span> which are “important” in some sense while controlling the false discovery rate. High correlations make it challenging to detect individually important covariates, so <strong>resolution-adaptive variable selection</strong> aims to detect disjoint groups of variables such that each detected group contains at least one important variable with high confidence. Of course, BLiP will make each detected group as small as possible, so we will discover individual signal variables when possible.</p>
</div>
<div class="section level2">
<h2 id="synthetic-data">Synthetic data<a class="anchor" aria-label="anchor" href="#synthetic-data"></a>
</h2>
<p>Below, we generate synthetic data of highly correlated covariates <span class="math inline">\(X = (X_1, \dots, X_p)\)</span> and a response <span class="math inline">\(Y\)</span>, where <span class="math inline">\(Y \mid X \sim \mathcal{N}(X \beta, \sigma^2)\)</span> follows a Gaussian linear model with sparse coefficients. We say that <span class="math inline">\(X_j\)</span> is a signal variable if <span class="math inline">\(\beta_j \ne 0\)</span>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">blipr</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>; <span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">100</span>; <span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">200</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">blipr</span><span class="fu">::</span><span class="fu"><a href="../reference/generate_regression_data.html">generate_regression_data</a></span><span class="op">(</span>n<span class="op">=</span><span class="va">n</span>, p<span class="op">=</span><span class="va">p</span><span class="op">)</span>

<span class="co"># Show heatmap of correlation matrix</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">RColorBrewer</span><span class="op">)</span>
<span class="va">colormap</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red"</span>,<span class="st">"white"</span>,<span class="st">"blue"</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>
<span class="fu">pheatmap</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pheatmap/man/pheatmap.html" class="external-link">pheatmap</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">X</span><span class="op">)</span>,
  breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">100</span> <span class="op">-</span> <span class="fl">50</span><span class="op">)</span><span class="op">/</span><span class="fl">50</span>,
  color<span class="op">=</span><span class="va">colormap</span>,
  cluster_rows<span class="op">=</span><span class="cn">F</span>,
  cluster_cols<span class="op">=</span><span class="cn">F</span>,
  main<span class="op">=</span><span class="st">'Correlation matrix of X'</span>
<span class="op">)</span></code></pre></div>
<p><img src="blipr-regression_files/figure-html/data-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="example-1-linear-spike-and-slab-model-blip">Example 1: Linear spike-and-slab model + BLiP<a class="anchor" aria-label="anchor" href="#example-1-linear-spike-and-slab-model-blip"></a>
</h2>
<p>We can run BLiP in two steps. First, we fit a Bayesian model to <span class="math inline">\((X, Y)\)</span>—in this case, we use a spike-and-slab model for sparse linear regression. Second, we run BLiP directly on top of the posterior samples from the Bayesian model, as shown below.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Step 1: fit a spike-and-slab model using NPrior. This takes ~30 seconds.</span>
<span class="co"># devtools::install_github("rabbitinasubmarine/NPrior")</span>
<span class="va">nprior</span> <span class="op">&lt;-</span> <span class="fu">NPrior</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/NPrior/man/NPrior_run.html" class="external-link">NPrior_run</a></span><span class="op">(</span>
   X<span class="op">=</span><span class="va">data</span><span class="op">$</span><span class="va">X</span>, y<span class="op">=</span><span class="va">data</span><span class="op">$</span><span class="va">y</span>, N<span class="op">=</span><span class="fl">5000</span>, prior<span class="op">=</span><span class="st">'SpSL-G'</span>, verbose<span class="op">=</span><span class="fl">0</span>
<span class="op">)</span>
<span class="va">post_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">nprior</span><span class="op">$</span><span class="va">ThetaSamples</span><span class="op">)</span></code></pre></div>
<p>Second, we apply BLiP to <code>post_samples</code>. Since this is a synthetic dataset, we can check whether the detections from BLiP are correct.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Step 2: apply BLiP</span>
<span class="va">detections</span> <span class="op">&lt;-</span> <span class="fu">blipr</span><span class="fu">::</span><span class="fu"><a href="../reference/BLiP.html">BLiP</a></span><span class="op">(</span>
  samples<span class="op">=</span><span class="va">post_samples</span>, error<span class="op">=</span><span class="st">'fdr'</span>, q<span class="op">=</span><span class="fl">0.1</span>, max_pep<span class="op">=</span><span class="fl">0.5</span>
<span class="op">)</span></code></pre></div>
<p>Lastly, since this is a synthetic dataset, we can check whether the detections from BLiP are correct.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Check whether detections are correct</span>
<span class="va">check_correctness</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">detections</span>, <span class="va">beta</span><span class="op">)</span> <span class="op">{</span>
 <span class="va">signals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">beta</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">detections</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">group</span> <span class="op">&lt;-</span> <span class="va">detections</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">group</span>
    <span class="va">pgroup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"{"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">group</span>, collapse<span class="op">=</span><span class="st">", "</span><span class="op">)</span>, <span class="st">"}"</span>, sep<span class="op">=</span><span class="st">''</span><span class="op">)</span>
    <span class="va">correct</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">signals</span>, <span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, 
      <span class="st">"correctly"</span>, 
      <span class="st">"incorrectly"</span>
    <span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"BLiP "</span>, <span class="va">correct</span>, <span class="st">" detected a signal in "</span>, <span class="va">pgroup</span>, <span class="st">".\n"</span>, sep<span class="op">=</span><span class="st">''</span><span class="op">)</span>
  <span class="op">}</span> 
<span class="op">}</span>
<span class="fu">check_correctness</span><span class="op">(</span><span class="va">detections</span>, <span class="va">data</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span>
<span class="co">#&gt; BLiP correctly detected a signal in {106}.</span>
<span class="co">#&gt; BLiP correctly detected a signal in {136}.</span>
<span class="co">#&gt; BLiP correctly detected a signal in {193, 194}.</span>
<span class="co">#&gt; BLiP correctly detected a signal in {95, 96, 97, 98, 99, 100}.</span>
<span class="co">#&gt; BLiP correctly detected a signal in {5}.</span>
<span class="co">#&gt; BLiP correctly detected a signal in {141}.</span>
<span class="co">#&gt; BLiP correctly detected a signal in {53, 54, 55, 56, 57}.</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example-2-susie-blip">Example 2: SuSiE + BLiP<a class="anchor" aria-label="anchor" href="#example-2-susie-blip"></a>
</h2>
<p>BLiP can apply on top of nearly any Bayesian model or algorithm, including variational algorithms. Here, we show how to apply BLiP on top of a SuSiE model <a href="https://www.biorxiv.org/content/10.1101/501114v4" class="external-link">(Wang et al, 2020)</a>. We do this in three steps: Step 1 is to fit SuSiE, Step 2 is to create candidate groups based off of the SuSiE outputs, and Step 3 is to apply BLiP.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Step 1: fit SuSiE</span>
<span class="co"># install.packages("susieR")</span>
<span class="va">susie_fit</span> <span class="op">&lt;-</span> <span class="fu">susieR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/susieR/man/susie.html" class="external-link">susie</a></span><span class="op">(</span>X<span class="op">=</span><span class="va">data</span><span class="op">$</span><span class="va">X</span>, y<span class="op">=</span><span class="va">data</span><span class="op">$</span><span class="va">y</span>, L<span class="op">=</span><span class="fl">10</span><span class="op">)</span>

<span class="co"># Step 2: Create candidate groups</span>
<span class="va">cand_groups</span> <span class="op">&lt;-</span> <span class="fu">blipr</span><span class="fu">::</span><span class="fu"><a href="../reference/susie_groups.html">susie_groups</a></span><span class="op">(</span>
  <span class="va">susie_fit</span><span class="op">$</span><span class="va">alpha</span>, X<span class="op">=</span><span class="va">data</span><span class="op">$</span><span class="va">X</span>, q<span class="op">=</span><span class="fl">0.1</span>
<span class="op">)</span>

<span class="co"># Step 3: fit BLiP</span>
<span class="va">detections</span> <span class="op">&lt;-</span> <span class="fu">blipr</span><span class="fu">::</span><span class="fu"><a href="../reference/BLiP.html">BLiP</a></span><span class="op">(</span>
  cand_groups<span class="op">=</span><span class="va">cand_groups</span>,q<span class="op">=</span><span class="fl">0.1</span>, error<span class="op">=</span><span class="st">'fdr'</span>, max_pep<span class="op">=</span><span class="fl">0.5</span>
<span class="op">)</span></code></pre></div>
<p>As we can see from below, SuSiE + BLiP localizes signals more precisely than SuSiE alone.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"The signals are"</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">beta</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span>
<span class="co">#&gt; The signals are 5 14 20 54 98 106 136 141 164 193</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"The SuSiE detections are: "</span><span class="op">)</span>
<span class="co">#&gt; The SuSiE detections are:</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span>
  <span class="va">susie_fit</span><span class="op">$</span><span class="va">sets</span><span class="op">$</span><span class="va">cs</span>, 
  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"{"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">x</span>, collapse<span class="op">=</span><span class="st">', '</span><span class="op">)</span>, <span class="st">"} "</span>, sep<span class="op">=</span><span class="st">''</span><span class="op">)</span><span class="op">}</span>
<span class="op">)</span>
<span class="co">#&gt; {136} {106} {5, 6} {193, 194}</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nThe SuSiE + BLiP detections are: "</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; The SuSiE + BLiP detections are:</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span>
  <span class="va">detections</span>, 
  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"{"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">group</span>, collapse<span class="op">=</span><span class="st">', '</span><span class="op">)</span>, <span class="st">"} "</span>, sep<span class="op">=</span><span class="st">''</span><span class="op">)</span><span class="op">}</span>
<span class="op">)</span>
<span class="co">#&gt; {136} {106} {5} {193, 194}</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example-3-spike-and-slab-probit-regression">Example 3: Spike-and-slab probit regression<a class="anchor" aria-label="anchor" href="#example-3-spike-and-slab-probit-regression"></a>
</h2>
<p>We can run BLiP on top of nearly any regression model, including various models for binary responses. For example, suppose we only observe a binary indicator <span class="math inline">\(Y^{\star}\)</span> as an outcome. We can apply BLiP directly on top of a sparse probit model in this setting, as shown below.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("BoomSpikeSlab")</span>
<span class="co"># Generate probit data</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">pdata</span> <span class="op">&lt;-</span> <span class="fu">blipr</span><span class="fu">::</span><span class="fu"><a href="../reference/generate_regression_data.html">generate_regression_data</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">300</span>, p<span class="op">=</span><span class="fl">200</span><span class="op">)</span>

<span class="co"># Step 1: fit probit model using 5 chains of 2000 samples</span>
<span class="va">ystar</span> <span class="op">&lt;-</span> <span class="va">pdata</span><span class="op">$</span><span class="va">y</span> <span class="op">&gt;</span> <span class="fl">0</span>
<span class="va">chains</span> <span class="op">&lt;-</span> <span class="fl">10</span>; <span class="va">niter</span> <span class="op">&lt;-</span> <span class="fl">2000</span>
<span class="va">post_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="va">p</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">c</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">chains</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">probit_model</span> <span class="op">&lt;-</span> <span class="fu">BoomSpikeSlab</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BoomSpikeSlab/man/probit.spike.html" class="external-link">probit.spike</a></span><span class="op">(</span>
    <span class="va">ystar</span> <span class="op">~</span> <span class="va">pdata</span><span class="op">$</span><span class="va">X</span> <span class="op">-</span> <span class="fl">1</span>, niter<span class="op">=</span><span class="va">niter</span>, ping<span class="op">=</span><span class="op">-</span><span class="fl">1</span>, seed<span class="op">=</span><span class="fl">123</span>, expected.model.size<span class="op">=</span><span class="fl">10</span>
  <span class="op">)</span>
  <span class="va">post_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">post_samples</span>, <span class="va">probit_model</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Step 2: run BLiP on the posterior samples</span>
<span class="va">detections</span> <span class="op">&lt;-</span> <span class="fu">blipr</span><span class="fu">::</span><span class="fu"><a href="../reference/BLiP.html">BLiP</a></span><span class="op">(</span>samples<span class="op">=</span><span class="va">post_samples</span>, q<span class="op">=</span><span class="fl">0.1</span>, error<span class="op">=</span><span class="st">'fdr'</span><span class="op">)</span>
<span class="fu">check_correctness</span><span class="op">(</span><span class="va">detections</span>, <span class="va">pdata</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span>
<span class="co">#&gt; BLiP correctly detected a signal in {181}.</span>
<span class="co">#&gt; BLiP correctly detected a signal in {154, 155}.</span>
<span class="co">#&gt; BLiP correctly detected a signal in {109, 110}.</span>
<span class="co">#&gt; BLiP correctly detected a signal in {87}.</span>
<span class="co">#&gt; BLiP correctly detected a signal in {187}.</span>
<span class="co">#&gt; BLiP incorrectly detected a signal in {7, 8}.</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="discussion-using-hierarchical-priors-to-avoid-misspecification">Discussion: Using hierarchical priors to avoid misspecification<a class="anchor" aria-label="anchor" href="#discussion-using-hierarchical-priors-to-avoid-misspecification"></a>
</h2>
<p>BLiP can wrap on top of nearly any Bayesian model, and in practice, it is fairly robust to some degree of model misspecification (see the paper for simulations and a discussion of this issue). That said, if the underlying model is extremely poorly specified, BLiP will violate FDR control. For example, in the following problem, the prior indicates that <span class="math inline">\(50\%\)</span> of the variables are signal variables, whereas in truth only <span class="math inline">\(5\%\)</span> of the variables are signal variables.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Sample from an obviously bad spike and slab model</span>
<span class="va">lm_bad</span> <span class="op">&lt;-</span> <span class="fu">BoomSpikeSlab</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BoomSpikeSlab/man/lm.spike.html" class="external-link">lm.spike</a></span><span class="op">(</span>
  <span class="va">data</span><span class="op">$</span><span class="va">y</span> <span class="op">~</span> <span class="va">data</span><span class="op">$</span><span class="va">X</span> <span class="op">-</span> <span class="fl">1</span>, niter<span class="op">=</span><span class="fl">2000</span>, ping<span class="op">=</span><span class="op">-</span><span class="fl">1</span>, expected.model.size<span class="op">=</span><span class="fl">100</span>, 
<span class="op">)</span>
<span class="va">detections_bad</span> <span class="op">&lt;-</span> <span class="fu">blipr</span><span class="fu">::</span><span class="fu"><a href="../reference/BLiP.html">BLiP</a></span><span class="op">(</span>samples<span class="op">=</span><span class="va">lm_bad</span><span class="op">$</span><span class="va">beta</span>, q<span class="op">=</span><span class="fl">0.1</span>, error<span class="op">=</span><span class="st">'fdr'</span><span class="op">)</span>
<span class="fu">check_correctness</span><span class="op">(</span><span class="va">detections_bad</span>, <span class="va">data</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span>
<span class="co">#&gt; BLiP correctly detected a signal in {106}.</span>
<span class="co">#&gt; BLiP correctly detected a signal in {136}.</span>
<span class="co">#&gt; BLiP correctly detected a signal in {5, 6}.</span>
<span class="co">#&gt; BLiP correctly detected a signal in {95, 96, 97, 98, 99, 100}.</span>
<span class="co">#&gt; BLiP correctly detected a signal in {53, 54, 55, 56}.</span>
<span class="co">#&gt; BLiP correctly detected a signal in {8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28}.</span>
<span class="co">#&gt; BLiP incorrectly detected a signal in {60, 140}.</span>
<span class="co">#&gt; BLiP incorrectly detected a signal in {111}.</span>
<span class="co">#&gt; BLiP incorrectly detected a signal in {4, 78}.</span>
<span class="co">#&gt; BLiP correctly detected a signal in {193, 194}.</span>
<span class="co">#&gt; BLiP correctly detected a signal in {141, 190}.</span></code></pre></div>
<p>As we can see, many of these detections are false positives due to the misspecified model. To avoid this situation, we recommend using <strong>hierarchical priors</strong> on unknown nuisance parameters like the sparsity level in regression problems with a conservative choice of hyperparameters. See <a href="https://arxiv.org/abs/2203.17208" class="external-link">Spector and Janson (2022)</a> for more discussion of this issue and a concrete suggestion for hierarchical priors in generalized linear models. When using MCMC algorithms, we also recommend <strong>running multiple MCMC chains</strong> with different initializations to protect against convergence issues As discussed in the paper, even when each individual MCMC chain fails to converge, often using multiple chains will overstate the uncertainty in the location of signals, leading to conservative but valid inference.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Asher Spector.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
